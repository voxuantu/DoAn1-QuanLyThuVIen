<header>
    <div class="container">
        <div class="header">
            <nav class="navbar navbar-expand-sm ">
                <div class="container-fluid">
                    <!-- Links -->
                    <div class="col-lg-9 col-md-9">
                        <ul class="navbar-nav">
                            <li class="nav-item">
                                <a href="/trangChu">
                                    <i class="fa-solid fa-house"></i>
                                </a>
                            </li>
                            <li class="nav-item dropdown" >
                                <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                                  Sách
                                </a>
                                <ul id="quanLyId" class="dropdown-menu" aria-labelledby="navbarDropdown">
                                  <li><a class="dropdown-item" href="/quanLySach">Quản lý sách</a></li>
                                  <li><a class="dropdown-item" href="/quanLyTacGia">Quản lý tác giả</a></li>
                                  <li><a class="dropdown-item" href="/quanLyTheLoai">Quản lý thể loại</a></li>
                                  <li><a class="dropdown-item" href="/quanLyNhaXuatBan">Quản lý nhà xuất bản</a></li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown" >
                                <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                                  Quản lý
                                </a>
                                <ul id="quanLyId" class="dropdown-menu" aria-labelledby="navbarDropdown">
                                  <li><a class="dropdown-item" href="/quanLyDocGia">Quản lý độc giả</a></li>
                                  <li><a class="dropdown-item" href="/quanLyNhanVien">Quản lý nhân viên</a></li>
                                </ul>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="/muonTraSach">Mượn trả sách</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="/thongKe">Thống kê</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="/quyDinh">Quy định</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="/gioiThieu">Giới thiệu</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="/lienHe">Liên hệ</a>
                            </li>
                        </ul>
                    </div>
                    <div class="col-lg-3 col-md-3">
                        <div class="text-end">
                            <% if(currentUser ==null) { %> 
                                <a href="/dangNhap">Đăng nhập</a>
                            <% }else{ %>
                                <ul>
                                    <ul class="header-right">
                                        <!-- dropdown thong bao -->
                                        <li class="dropdown">
                                            <a href="#" class="text-decoration-none" role="button" id="dropdownNotify" data-bs-toggle="dropdown" aria-expanded="false">
                                                <i class="fa-solid fa-bell">
                                                    <span class="badge bg-danger text-wrap notifi-counter">7</span>
                                                </i>
                                            </a>
                                            <ul id="notify-box" class="notifi-box dropdown-menu dropdown-menu-lg-end dropdown-menu-macos mx-0 border-0 shadow" aria-labelledby="dropdownNotify">
                                                <li><h2>Thông báo <span>0</span></h2></li>
                                            </ul>
                                        </li>
                                        <!-- dropdown trang ca nhan -->
                                        <li class="dropdown">
                                            <a href="#" class="text-decoration-none" role="button" id="dropdownUser" data-bs-toggle="dropdown" aria-expanded="false">
                                                <i class="fa-solid fa-circle-user"></i>
                                            </a>
                                            <ul class="dropdown-menu dropdown-menu-lg-end dropdown-menu-macos mx-0 border-0 shadow userDropdown" aria-labelledby="dropdownUser">
                                                <li>
                                                    <form id="trangCaNhanForm" action="/trangCaNhan" method="get">
                                                        <a class="dropdown-item" href="javascript:{}" 
                                                            onclick="document.getElementById('trangCaNhanForm').submit();">
                                                            <i class="fa-solid fa-user"></i> Trang cá nhân
                                                        </a>
                                                   </form>
                                                </li>
                                                <li>
                                                    <form id="dangXuatForm" action="/trangChu/dangXuat?_method=DELETE" method="post">
                                                        <a class="dropdown-item" href="javascript:{}" 
                                                            onclick="document.getElementById('dangXuatForm').submit();">
                                                            <i class="fa-solid fa-arrow-right-from-bracket"></i> Đăng xuất
                                                        </a>
                                                   </form>
                                                </li>
                                            </ul>
                                        </li>
                                    </ul>
                                </ul>
                            <% } %> 
                        </div>
                    </div>
                </div>
            </nav>
        </div>
    </div>
</header>
<script>
    $(document).ready(function(){
        $.ajax({
            url: '/api/layThongBaoThuThu',
            dataType: 'json',
            type: 'get',
            data: {},
            success: function (data1) {
                $('#notify-box li:first-child h2 span').text(data1.length)
                $('#dropdownNotify span').text(data1.length)
                console.log(data1)
                data1.forEach(element => {
                    var content = "<li>"
                            +       "<a onclick='ViewNotification(this)' data-bs-id='"+element._id+"'>"
                            +           "<div class='notifi-item'>"
                            +               "<img class='img-fluid rounded-circle ms-2 me-3' src='/icon/avatar.png' alt='avatar'>"
                            +               "<div>"
                            +                   "<h5>"+ element.title +"</h5>"
                            +                   "<p>"+ element.message +"</p>"
                            +               "</div>"
                            +           "</div>"
                            +       "</a>"
                            +    "</li>"
                    $('#notify-box').append(content)
                });
            },
            error: function (err) {
                console.log(err)
            }
        })
    })
    function ViewNotification(a){
        var id = a.getAttribute('data-bs-id')
        $.ajax({
            url: '/api/checkThongBao',
            dataType: 'json',
            type: 'post',
            data: {
                id : id
            },
            success: function (data1) {
                if(data1 == 'success'){
                    window.location.replace('/muonTraSach')
                }
            },
            error: function (err) {
                console.log(err)
            }
        })
    }
</script>
<script defer>
    var socket = io();

    socket.on('show-notification', function(data){
        appendNotification(data)
    })

    function appendNotification(data){
        var num = $('#notify-box li:first-child h2 span').text()
        $('#notify-box li:first-child h2 span').text(parseInt(num) + 1)
        $('#dropdownNotify span').text(parseInt(num) + 1)
        var content = "<li>"
                    +       "<a onclick='ViewNotification(this)' data-bs-id='"+data.id+"'>"
                    +           "<div class='notifi-item'>"
                    +               "<img class='img-fluid rounded-circle ms-2 me-3' src='/icon/avatar.png' alt='avatar'>"
                    +               "<div>"
                    +                   "<h5>"+ data.title +"</h5>"
                    +                   "<p>"+ data.message +"</p>"
                    +               "</div>"
                    +           "</div>"
                    +       "</a>"
                    +    "</li>"
        $('#notify-box').append(content)
    }
</script>